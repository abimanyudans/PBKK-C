<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Knowledge Base - Sistem Deteksi Penipuan Kartu Kredit</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1976d2" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="FraudDetect" />
    <meta
      name="description"
      content="Knowledge Base System - Deteksi penipuan dengan reasoning"
    />

    <!-- Icons -->
    <link rel="icon" href="{{ url_for('static', filename='images/1.ico') }}" />
    <link
      rel="apple-touch-icon"
      href="{{ url_for('static', filename='images/icon-192.png') }}"
    />

    <!-- PWA Manifest -->
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Stylesheets -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>

  <body>
    <button class="menu-toggle" onclick="toggleSidebar()">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <nav class="sidebar">
      <h2>Fraud Detection</h2>
      <a href="index.html">Dashboard</a>
      <a href="visualizations.html">Visualizations</a>
      <a href="analysis.html">Analysis</a>
      <a href="model.html">ML Model</a>
      <a href="amount-trends.html">Amount Trends</a>
      <a href="feature.html">Feature</a>
      <a href="theory.html">Theory</a>
      <a href="knowledge-base.html" class="active">Knowledge Base</a>
    </nav>
    <div class="main-content">
      <h1>Knowledge Base System</h1>
      <p class="subtitle">
        Sistem Berbasis Pengetahuan untuk Deteksi Penipuan dengan Rule-Based
        Reasoning
      </p>

      <!-- Section: Test KB System -->
      <div class="card">
        <h2>Test Knowledge Base System</h2>
        <p>Masukkan data transaksi untuk melihat reasoning lengkap dari KB</p>

        <div
          style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap"
        >
          <button
            onclick="generateFraudData()"
            class="btn-secondary"
            style="background: #f44336"
          >
            <i class="fas fa-exclamation-triangle"></i> Generate Data Fraud
          </button>
          <button
            onclick="generateLegitimateData()"
            class="btn-secondary"
            style="background: #4caf50"
          >
            <i class="fas fa-check-circle"></i> Generate Data Legitimate
          </button>
        </div>

        <div class="form-group">
          <label>Model ML:</label>
          <select id="kb-model-select" class="form-control">
            <option value="xgb" selected>XGBoost (Best)</option>
            <option value="rf">Random Forest</option>
            <option value="gb">Gradient Boosting</option>
            <option value="logreg">Logistic Regression</option>
            <option value="svm">SVM</option>
            <option value="knn">KNN</option>
            <option value="dt">Decision Tree</option>
            <option value="adaboost">AdaBoost</option>
          </select>
        </div>

        <div class="form-group">
          <label>Time (detik sejak transaksi pertama):</label>
          <input
            type="number"
            id="kb-time"
            class="form-control"
            value="7200"
            min="0"
            max="172800"
            placeholder="0 - 172800 (2 hari)"
          />
          <small style="color: #888"
            >Rentang wajar: 0 (awal) sampai 172800 (2 hari)</small
          >
        </div>

        <div class="form-group">
          <label>Amount ($):</label>
          <input
            type="number"
            id="kb-amount"
            class="form-control"
            value="3500"
            step="0.01"
            min="0"
            max="10000"
            placeholder="0 - 10000"
          />
          <small style="color: #888">Rentang wajar: 0 - 10.000</small>
        </div>

        <div class="form-group">
          <label>V1-V28 Features (comma-separated, 28 values):</label>
          <textarea
            id="kb-v-features"
            class="form-control"
            rows="3"
            placeholder="Contoh: -2.5,4.5,...,0.3"
          >
-2.5,4.5,-1.2,3.8,0.5,-0.8,1.2,-2.1,0.5,0.3,-0.4,0.7,0.2,-0.9,0.4,0.6,-0.3,0.1,0.8,-0.5,0.2,0.4,-0.6,0.3,0.1,-0.2,0.5,0.3</textarea
          >
          <small style="color: #888"
            >Rentang wajar tiap nilai: -10 sampai 10</small
          >
        </div>

        <button onclick="testKBSystem()" class="btn-primary">
          <i class="fas fa-brain"></i> Analisis dengan KB
        </button>

        <div id="kb-loading" style="display: none; margin-top: 20px">
          <i class="fas fa-spinner fa-spin"></i> Memproses reasoning...
        </div>
      </div>

      <!-- Section: Results -->
      <div id="kb-results" style="display: none">
        <!-- ML Prediction Card -->
        <div class="card">
          <h2>ü§ñ Hasil Machine Learning</h2>
          <div id="ml-result"></div>
        </div>

        <!-- KB Analysis Card -->
        <div class="card">
          <h2>Analisis Knowledge Base</h2>
          <div id="kb-analysis"></div>
        </div>

        <!-- Final Decision Card -->
        <div class="card" id="final-decision-card">
          <h2>‚öñÔ∏è Keputusan Final (Hybrid ML + KB)</h2>
          <div id="final-decision"></div>
        </div>

        <!-- Reasoning Trace Card -->
        <div class="card">
          <h2>üîç Jejak Reasoning</h2>
          <div id="reasoning-trace"></div>
        </div>

        <!-- Detected Patterns Card -->
        <div class="card">
          <h2>‚ö†Ô∏è Pola Penipuan Terdeteksi</h2>
          <div id="detected-patterns"></div>
        </div>

        <!-- Context Summary Card -->
        <div class="card">
          <h2>Ringkasan Konteks</h2>
          <div id="context-summary"></div>
        </div>
      </div>

      <!-- Section: KB Rules -->
      <div class="card">
        <h2>Aturan dalam Knowledge Base</h2>
        <button onclick="loadKBRules()" class="btn-secondary">
          <i class="fas fa-list"></i> Tampilkan Semua Aturan
        </button>
        <div id="kb-rules-list" style="margin-top: 20px"></div>
      </div>

      <!-- Section: About KB -->
      <div class="card">
        <h2>Tentang Knowledge Base System</h2>
        <div class="info-section">
          <h3>Apa itu Knowledge Base System?</h3>
          <p>
            Knowledge Base (KB) adalah sistem yang menyimpan pengetahuan domain
            dalam bentuk fakta dan aturan, kemudian menggunakan inference engine
            untuk melakukan reasoning dan menghasilkan keputusan yang dapat
            dijelaskan.
          </p>

          <h3>Komponen KB System:</h3>
          <ul>
            <li>
              <strong>Knowledge Base:</strong> Menyimpan fakta tentang pola
              penipuan, threshold, dan statistik
            </li>
            <li>
              <strong>Rule Engine:</strong> Evaluasi aturan bisnis berdasarkan
              kondisi transaksi
            </li>
            <li>
              <strong>Inference Engine:</strong> Forward chaining untuk
              reasoning dan kombinasi dengan ML
            </li>
          </ul>

          <h3>Keuntungan Hybrid ML + KB:</h3>
          <ul>
            <li>
              ‚úÖ <strong>Explainability:</strong> Setiap keputusan dapat
              dijelaskan dengan reasoning yang jelas
            </li>
            <li>
              ‚úÖ <strong>Business Rules:</strong> Dapat menambahkan aturan
              bisnis spesifik perusahaan
            </li>
            <li>
              ‚úÖ <strong>Adaptability:</strong> Aturan dapat diubah tanpa
              retrain model ML
            </li>
            <li>
              ‚úÖ <strong>Higher Accuracy:</strong> Kombinasi ML pattern
              recognition + rule-based logic
            </li>
            <li>
              ‚úÖ <strong>Risk Adjustment:</strong> KB dapat menyesuaikan risk
              score berdasarkan konteks
            </li>
          </ul>

          <h3>Contoh Aturan:</h3>
          <div
            style="
              background: #f0f0f0;
              padding: 15px;
              border-left: 4px solid #2196f3;
              margin-top: 10px;
            "
          >
            <p><strong>R5:</strong> "Kombinasi Waktu dan Nominal Tinggi"</p>
            <p>
              <em>Kondisi:</em> Transaksi terjadi jam 23:00-05:00 DAN nominal >
              $ 1000
            </p>
            <p><em>Aksi:</em> Flag sebagai high risk</p>
            <p><em>Bobot:</em> 0.4 (40% adjustment)</p>
            <p>
              <em>Alasan:</em> Penipuan sering terjadi malam hari dengan nominal
              besar
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <div class="footer-section">
          <h3>Developed By</h3>
          <ul>
            <li>Abimanyu Danendra Andarfebano (5025231182)</li>
            <li>Felda Ega Fadhilla (5025231199)</li>
            <li>Naufal Dariskarim (5025231027)</li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p><strong>Final Project RSBP-C</strong></p>
        <p>Departemen Teknik Informatika</p>
        <p>Institut Teknologi Sepuluh Nopember Surabaya</p>
        <p>&copy; 2025 Sistem Deteksi Penipuan Kartu Kredit</p>
      </div>
    </footer>

    <script src="{{ url_for('static', filename='js/pwa.js') }}"></script>
    <script>
      function toggleSidebar() {
        document.querySelector(".sidebar").classList.toggle("active");
      }

      function generateFraudData() {
        // Menggunakan data fraud ASLI dari ML Model sample yang PASTI terdeteksi fraud
        // Sample fraud dari model.js: id=9064, banyak V ekstrim, amount=1809.68
        const fraudSamples = [
          // Sample 1: Dari model.js - confirmed fraud
          [
            9064, -3.499107537, 0.258555161, -4.489558073, 4.853894351,
            -6.974521545, 3.628382091, 5.431270921, -1.946733711, -0.775680093,
            -1.987773188, 4.690395666, -6.998042432, 1.454011986, -3.738023334,
            0.317742063, -2.013542681, -5.136135103, -1.183822117, 1.663394014,
            -3.042625757, -1.052368256, 0.204816874, -2.11900744, 0.170278608,
            -0.393844118, 0.296367194, 1.985913218, -0.900451638, 1809.68,
          ],
          // Sample 2: Variasi dengan V features ekstrim lain
          [
            5000, -4.2, 1.5, -3.8, 5.1, -5.5, 4.0, 4.8, -2.1, -1.2, -2.5, 3.9,
            -5.2, 1.8, -4.1, 0.5, -2.8, -4.5, -1.5, 2.0, -3.5, -1.3, 0.3, -2.5,
            0.2, -0.5, 0.4, 2.2, -1.1, 1500,
          ],
          // Sample 3: Variasi lain
          [
            8000, -3.8, 0.5, -5.1, 4.2, -6.1, 3.2, 5.8, -1.5, -0.9, -1.7, 5.2,
            -6.5, 1.2, -3.2, 0.4, -1.8, -4.8, -1.0, 1.8, -2.8, -0.9, 0.1, -1.9,
            0.3, -0.3, 0.5, 1.7, -0.8, 2100,
          ],
        ];

        // Pilih random sample
        const sample =
          fraudSamples[Math.floor(Math.random() * fraudSamples.length)];

        document.getElementById("kb-time").value = sample[0];
        document.getElementById("kb-amount").value = sample[29].toFixed(2);
        document.getElementById("kb-v-features").value = sample
          .slice(1, 29)
          .map((v) => v.toFixed(2))
          .join(",");
      }

      function generateLegitimateData() {
        // Menggunakan data legitimate ASLI dari ML Model sample yang PASTI terdeteksi legitimate
        // Sample legitimate dari model.js: id=3756, V normal, amount=68.15
        const legitSamples = [
          // Sample 1: Dari model.js - confirmed legitimate
          [
            3756, 1.350757382, -0.767437703, -0.944464989, -1.595061785,
            1.432443287, 3.284171247, -1.135628638, 0.703558091, 0.357023709,
            0.269818306, 1.009895195, -3.172259421, 1.873844283, 1.418459674,
            0.263151375, 1.537059966, 0.446842808, -0.860466472, 0.758219283,
            0.275386238, -0.262242226, -0.912080261, 0.058162339, 0.921364875,
            0.347414098, -0.511174316, -0.024878235, 0.020000189, 68.15,
          ],
          // Sample 2: Variasi dengan V features normal
          [
            4500, 0.8, -0.5, -0.9, -1.2, 1.1, 2.5, -0.8, 0.6, 0.3, 0.2, 0.9,
            -2.1, 1.5, 1.2, 0.4, 1.3, 0.5, -0.7, 0.6, 0.3, -0.3, -0.8, 0.1, 0.9,
            0.4, -0.4, -0.1, 0.0, 125.5,
          ],
          // Sample 3: Variasi lain
          [
            6000, 1.2, -0.6, -1.0, -1.4, 1.3, 2.8, -1.0, 0.7, 0.4, 0.3, 1.0,
            -2.5, 1.7, 1.3, 0.3, 1.4, 0.4, -0.8, 0.7, 0.2, -0.2, -0.9, 0.0, 1.0,
            0.3, -0.5, 0.0, 0.1, 89.99,
          ],
        ];

        // Pilih random sample
        const sample =
          legitSamples[Math.floor(Math.random() * legitSamples.length)];

        document.getElementById("kb-time").value = sample[0];
        document.getElementById("kb-amount").value = sample[29].toFixed(2);
        document.getElementById("kb-v-features").value = sample
          .slice(1, 29)
          .map((v) => v.toFixed(2))
          .join(",");
      }

      async function testKBSystem() {
        const model = document.getElementById("kb-model-select").value;
        const time = parseFloat(document.getElementById("kb-time").value);
        const amount = parseFloat(document.getElementById("kb-amount").value);
        const vFeaturesStr = document.getElementById("kb-v-features").value;

        // Validasi input
        if (isNaN(time) || time < 0 || time > 172800) {
          alert("Time harus di antara 0 dan 172800 detik (2 hari)");
          return;
        }
        if (isNaN(amount) || amount < 0 || amount > 10000) {
          alert("Amount harus di antara 0 dan 10.000");
          return;
        }

        // Parse V features
        const vFeatures = vFeaturesStr
          .split(",")
          .map((v) => parseFloat(v.trim()));

        if (vFeatures.length !== 28) {
          alert("Harus ada 28 nilai untuk V1-V28!");
          return;
        }
        if (vFeatures.some((v) => isNaN(v) || v < -10 || v > 10)) {
          alert("Setiap nilai V1-V28 harus di antara -10 dan 10");
          return;
        }

        // Prepare features array: [id, V1-V28, Amount]
        // Menggunakan time sebagai id agar kompatibel dengan backend ML Model
        const features = [time, ...vFeatures, amount];

        // Show loading
        document.getElementById("kb-loading").style.display = "block";
        document.getElementById("kb-results").style.display = "none";

        try {
          // Call API
          const response = await fetch("/predict_with_kb", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ features: features, model: model }),
          });

          const result = await response.json();

          // Display results
          displayKBResults(result);
        } catch (error) {
          alert("Error: " + error.message);
        } finally {
          document.getElementById("kb-loading").style.display = "none";
        }
      }

      function displayKBResults(result) {
        const { ml_prediction, kb_result, hybrid_decision, model_used } =
          result;

        // ML Result
        const mlHtml = `
          <div class="result-item">
            <strong>Model:</strong> ${model_used.toUpperCase()}<br>
            <strong>Prediksi:</strong> ${
              ml_prediction.prediction === 1
                ? '<span style="color: red;">FRAUD</span>'
                : '<span style="color: green;">LEGITIMATE</span>'
            }<br>
            <strong>Probabilitas:</strong> ${(
              ml_prediction.probability * 100
            ).toFixed(2)}%<br>
            <strong>Akurasi Model:</strong> ${(
              ml_prediction.accuracy * 100
            ).toFixed(2)}%
          </div>
        `;
        document.getElementById("ml-result").innerHTML = mlHtml;

        // KB Analysis
        const rulesHtml =
          kb_result.rules_fired.length > 0
            ? kb_result.rules_fired
                .map(
                  (r) => `
              <div style="background: #fff3cd; padding: 10px; margin: 5px 0; border-left: 3px solid #ffc107;">
                <strong>[${r.rule_id}] ${r.rule_name}</strong><br>
                ${r.description}<br>
                <em>Bobot: ${r.weight}, Aksi: ${r.action}</em>
              </div>
            `
                )
                .join("")
            : "<p>Tidak ada aturan yang terpicu</p>";

        document.getElementById("kb-analysis").innerHTML = `
          <p><strong>Jumlah Aturan Terpicu:</strong> ${
            kb_result.rules_fired.length
          }</p>
          <p><strong>Penyesuaian Risiko:</strong> ${(
            kb_result.risk_adjustment * 100
          ).toFixed(2)}%</p>
          ${rulesHtml}
        `;

        // Final Decision
        const decisionColor =
          hybrid_decision.prediction === 1 ? "#f44336" : "#4CAF50";
        const decisionText =
          hybrid_decision.prediction === 1
            ? "FRAUD (PENIPUAN)"
            : "LEGITIMATE (SAH)";

        document.getElementById(
          "final-decision-card"
        ).style.borderLeft = `5px solid ${decisionColor}`;
        document.getElementById("final-decision").innerHTML = `
          <div style="background: ${decisionColor}20; padding: 20px; border-radius: 5px;">
            <h3 style="color: ${decisionColor}; margin-top: 0;">${decisionText}</h3>
            <p><strong>Risk Score Final:</strong> ${(
              hybrid_decision.risk_score * 100
            ).toFixed(2)}%</p>
            <p><strong>Tingkat Kepercayaan:</strong> ${
              hybrid_decision.confidence
            }</p>
            <p><strong>Rekomendasi:</strong></p>
            <div style="background: white; padding: 15px; border-left: 3px solid ${decisionColor};">
              ${hybrid_decision.recommendation}
            </div>
          </div>
        `;

        // Reasoning Trace
        const traceHtml =
          kb_result.reasoning_trace.length > 0
            ? kb_result.reasoning_trace.map((t) => `<li>${t}</li>`).join("")
            : "<li>Tidak ada jejak reasoning</li>";
        document.getElementById(
          "reasoning-trace"
        ).innerHTML = `<ul>${traceHtml}</ul>`;

        // Detected Patterns
        const patternsHtml =
          kb_result.detected_patterns.length > 0
            ? kb_result.detected_patterns
                .map((p) => {
                  // Ganti Rp menjadi $ pada deskripsi pola
                  const desc =
                    typeof p.description === "string"
                      ? p.description.replace(/Rp\s?/g, "$ ")
                      : p.description;
                  return `
              <div style="background: #ffebee; padding: 10px; margin: 5px 0; border-left: 3px solid #f44336;">
                <strong>${p.pattern}</strong> [${p.risk_level}]<br>
                ${desc}
              </div>
            `;
                })
                .join("")
            : '<p style="color: green;">‚úì Tidak ada pola penipuan yang terdeteksi</p>';
        document.getElementById("detected-patterns").innerHTML = patternsHtml;

        // Context Summary
        const contextHtml = Object.entries(kb_result.context_summary)
          .map(([key, value]) => {
            // Ganti Rp menjadi $ pada value
            const newValue =
              typeof value === "string" ? value.replace(/Rp\s?/g, "$ ") : value;
            return `<li><strong>${key.replace(
              /_/g,
              " "
            )}:</strong> ${newValue}</li>`;
          })
          .join("");
        document.getElementById(
          "context-summary"
        ).innerHTML = `<ul>${contextHtml}</ul>`;

        // Show results
        document.getElementById("kb-results").style.display = "block";
        document
          .getElementById("kb-results")
          .scrollIntoView({ behavior: "smooth" });
      }

      async function loadKBRules() {
        const rulesList = document.getElementById("kb-rules-list");
        const button = event.target.closest("button");

        // Toggle: jika sudah ada konten, hapus (tutup)
        if (rulesList.innerHTML.trim() !== "") {
          rulesList.innerHTML = "";
          button.innerHTML =
            '<i class="fas fa-list"></i> Tampilkan Semua Aturan';
          return;
        }

        // Jika belum ada konten, load dari server (buka)
        try {
          button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...';
          const response = await fetch("/get_kb_rules");
          const data = await response.json();

          const rulesHtml = `
            <h3>Total Aturan: ${data.total_rules}</h3>
            ${data.rules
              .map(
                (r) => `
              <div style="background: #f5f5f5; padding: 15px; margin: 10px 0; border-left: 4px solid #2196F3;">
                <h4>[${r.id}] ${r.name}</h4>
                <p><strong>Kategori:</strong> ${r.category}</p>
                <p><strong>Kondisi:</strong> <code>${r.condition}</code></p>
                <p><strong>Aksi:</strong> ${r.action}</p>
                <p><strong>Bobot:</strong> ${r.weight} | <strong>Prioritas:</strong> ${r.priority}</p>
                <p><em>${r.description}</em></p>
              </div>
            `
              )
              .join("")}
            
            <h3 style="margin-top: 30px;">Pola Penipuan yang Diketahui:</h3>
            ${data.fraud_patterns
              .map(
                (p) => `
              <div style="background: #fff3cd; padding: 15px; margin: 10px 0; border-left: 4px solid #ffc107;">
                <h4>${p.pattern} [${p.risk_level}]</h4>
                <p>${p.description}</p>
              </div>
            `
              )
              .join("")}
            
            <h3 style="margin-top: 30px;">Fakta dalam Knowledge Base:</h3>
            <ul>
              <li><strong>Jam Berisiko Tinggi:</strong> ${data.facts.high_risk_hours.join(
                ", "
              )}</li>
              <li><strong>Threshold Nominal Mencurigakan:</strong> $ ${
                data.facts.thresholds.suspicious_amount
              }</li>
              <li><strong>Threshold Nominal Sangat Tinggi:</strong> $ ${
                data.facts.thresholds.very_high_amount
              }</li>
              <li><strong>Threshold Micro Transaction:</strong> $ ${
                data.facts.thresholds.micro_transaction
              }</li>
            </ul>
          `;

          rulesList.innerHTML = rulesHtml;
          button.innerHTML = '<i class="fas fa-times"></i> Sembunyikan Aturan';
        } catch (error) {
          alert("Error loading rules: " + error.message);
          button.innerHTML =
            '<i class="fas fa-list"></i> Tampilkan Semua Aturan';
        }
      }
    </script>
  </body>
</html>
